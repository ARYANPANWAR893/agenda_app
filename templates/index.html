{% extends 'base.html' %}

{% block content %}
<div class="row">
  <!-- Formulaire d'ajout de t√¢che -->
  <div class="col-md-6">
    <div class="card mb-4 shadow">
      <div class="card-header bg-primary text-white">Ajouter une t√¢che</div>
      <div class="card-body">
        <form method="POST" action="/add">
          <div class="mb-3">
            <label for="event" class="form-label">Titre</label>
            <input type="text" class="form-control" id="event" name="event" required>
          </div>
          <div class="mb-3">
            <label for="description" class="form-label">Description</label>
            <textarea class="form-control" id="description" name="description" rows="2"></textarea>
          </div>
          <div class="mb-3">
            <label for="date" class="form-label">Date</label>
            <input type="date" class="form-control" id="date" name="date" required>
          </div>
          <div class="mb-3">
            <label for="time" class="form-label">Heure</label>
            <input type="time" class="form-control" id="time" name="time" required>
          </div>
          <div class="mb-3">
            <label for="classe" class="form-label">Classe</label>
            <select class="form-select" id="classe" name="classe" required>
              <option value="">-- S√©lectionner un p√¥le --</option>
              <option value="Direction">Direction</option>
              <option value="P√¥le Compta">P√¥le Compta</option>
              <option value="P√¥le Social">P√¥le Social</option>
              <option value="P√¥le juridique">P√¥le juridique</option>
              <option value="P√¥le Communication">P√¥le Communication</option>
              <option value="Assistance Compta">Assistance Compta</option>
              <option value="Assistance Paie">Assistance Paie</option>
              <option value="Assistance juridique">Assistance juridique</option>
              <option value="Assistance Communication">Assistance Communication</option>
            </select>
          </div>
          <button type="submit" class="btn btn-success w-100">Ajouter</button>
        </form>
      </div>
    </div>
  </div>

  <!-- Liste des t√¢ches -->
  <div class="col-md-6">
    <div class="card shadow">
      <div class="card-header bg-secondary text-white">üìÖ T√¢ches √† venir</div>
      <div class="card-body">
        {% set groupes = {} %}
        {% for e in events %}
          {% set key = e.classe %}
          {% if key not in groupes %}
            {% set _ = groupes.update({key: []}) %}
          {% endif %}
          {% set _ = groupes[key].append(e) %}
        {% endfor %}

        {% for classe, elist in groupes.items() %}
          <h6 class="mt-3 text-primary">üìò {{ classe }}</h6>
          <ul class="list-group mb-2">
            {% for ev in elist %}
              <li class="list-group-item
                  {% if ev.classe == 'Direction' %}list-group-item-primary
                  {% elif ev.classe == 'P√¥le Compta' %}list-group-item-success
                  {% elif ev.classe == 'P√¥le Social' %}list-group-item-warning
                  {% elif ev.classe == 'P√¥le juridique' %}list-group-item-danger
                  {% elif ev.classe == 'P√¥le Communication' %}list-group-item-info
                  {% elif ev.classe.startswith('Assistance') %}list-group-item-secondary
                  {% else %}list-group-item-light
                  {% endif %}">
                <strong>
                  {% if ev.classe == 'Direction' %}
                    <span class="badge bg-primary">Direction</span>
                  {% elif ev.classe == 'P√¥le Compta' %}
                    <span class="badge bg-success">P√¥le Compta</span>
                  {% elif ev.classe == 'P√¥le Social' %}
                    <span class="badge bg-warning text-dark">P√¥le Social</span>
                  {% elif ev.classe == 'P√¥le juridique' %}
                    <span class="badge bg-danger">P√¥le juridique</span>
                  {% elif ev.classe == 'P√¥le Communication' %}
                    <span class="badge bg-info">P√¥le Communication</span>
                  {% elif ev.classe.startswith('Assistance') %}
                    <span class="badge bg-secondary">{{ ev.classe }}</span>
                  {% else %}
                    <span class="badge bg-light text-dark">{{ ev.classe }}</span>
                  {% endif %}
                  {{ ev.title }}
                </strong><br>
                <small>{{ ev.start }}</small><br>
                {{ ev.description }}<br>
                <button 
                  type="button"
                  class="btn btn-sm btn-outline-danger mt-1" 
                  onclick="confirmDeletion('{{ ev.id }}', '{{ ev.title }}', '{{ ev.description }}', '{{ ev.start }}')">
                  Supprimer
                </button>
                <button 
                  type="button"
                  class="btn btn-sm btn-outline-success mt-1" 
                  onclick="confirmValidation('{{ ev.id }}', '{{ ev.title }}', '{{ ev.description }}', '{{ ev.start }}')">
                  Valider
                </button>
              </li>
            {% endfor %}
          </ul>
        {% else %}
          <p class="text-muted">Aucune t√¢che √† afficher.</p>
        {% endfor %}
      </div>
    </div>
  </div>
</div>

<!-- Modal de confirmation de suppression -->
<div class="modal fade" id="confirmModal" tabindex="-1" aria-labelledby="confirmModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header bg-danger text-white">
        <h5 class="modal-title" id="confirmModalLabel">Confirmation de Suppression</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <p id="eventDetails"></p>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
        <button type="button" class="btn btn-danger" id="confirmDeleteButton">Confirmer</button>
      </div>
    </div>
  </div>
</div>

<!-- Modal de confirmation de validation -->
<div class="modal fade" id="confirmValidationModal" tabindex="-1" aria-labelledby="confirmValidationModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header bg-success text-white">
        <h5 class="modal-title" id="confirmValidationModalLabel">Confirmation de Validation</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <p id="validationDetails"></p>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
        <button type="button" class="btn btn-success" id="confirmValidateButton">Confirmer</button>
      </div>
    </div>
  </div>
</div>

<!-- Script pour la gestion des modals -->
<script>
let currentEventId = null;

function confirmDeletion(eventId, eventTitle, eventDescription, eventDate) {
    const eventDetails = `<strong>${eventTitle}</strong><br><small>Date : ${eventDate}</small><br><em>Description : ${eventDescription}</em>`;
    document.getElementById('eventDetails').innerHTML = `Voulez-vous vraiment supprimer cette t√¢che ?<br><br>${eventDetails}`;
    currentEventId = eventId;
    const confirmModal = new bootstrap.Modal(document.getElementById('confirmModal'));
    confirmModal.show();
}

function confirmValidation(eventId, eventTitle, eventDescription, eventDate) {
    const validationDetails = `<strong>${eventTitle}</strong><br><small>Date : ${eventDate}</small><br><em>Description : ${eventDescription}</em>`;
    document.getElementById('validationDetails').innerHTML = `Voulez-vous vraiment valider cette t√¢che ?<br><br>${validationDetails}`;
    currentEventId = eventId;
    const confirmValidationModal = new bootstrap.Modal(document.getElementById('confirmValidationModal'));
    confirmValidationModal.show();
}

// Confirmation de validation
document.getElementById('confirmValidateButton').onclick = function() {
    fetch(`/validate_event/${currentEventId}`, {
        method: 'POST'
    })
    .then(response => {
        if (response.ok) {
            alert("‚úÖ La t√¢che a √©t√© valid√©e avec succ√®s.");
            window.location.reload();
        } else {
            alert("‚ùå Erreur lors de la validation de la t√¢che.");
        }
    })
    .catch(error => {
        alert("‚ùå Erreur de connexion avec le serveur.");
    });
};
</script>
{% endblock %}
